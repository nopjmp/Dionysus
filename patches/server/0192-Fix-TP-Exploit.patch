From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: nopjmp <kthompson@hey.com>
Date: Wed, 16 Nov 2022 21:07:07 -0600
Subject: [PATCH] Fix TP Exploit


diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index 66b4114c2fcb536e2860fcd790276271234ac24b..bbbc51284426d8194fbdb99bcdd7dd21eef638a1 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -1551,6 +1551,14 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
         return getBukkitEntity().getScoreboard().getHandle();
     }
 
+    @Override
+    public void setPositionRotation(double d0, double d1, double d2, float f, float f1) {
+        super.setPositionRotation(d0, d1, d2, f, f1);
+        if (this.playerConnection != null) {
+            this.playerConnection.resetLastPositionRotation();
+        }
+    }
+
     public void reset() {
         float exp = 0;
         boolean keepInventory = this.world.getGameRules().getBoolean("keepInventory");
diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 7086a0e40466062468a759dddb2ca2d6eeb7acc7..7987cd796efb403547d99b52d3021f19b54ad3a3 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -140,6 +140,16 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
     private final static HashSet<Integer> invalidItems = new HashSet<Integer>(java.util.Arrays.asList(8, 9, 10, 11, 26, 34, 36, 43, 51, 55, 59, 62, 63, 64, 68, 71, 74, 75, 83, 90, 92, 93, 94, 104, 105, 115, 117, 118, 119, 125, 127, 132, 140, 141, 142, 144)); // TODO: Check after every update.
     // CraftBukkit end
 
+    public void resetLastPositionRotation() {
+        lastPosX = Double.MAX_VALUE;
+        lastPosY = Double.MAX_VALUE;
+        lastPosZ = Double.MAX_VALUE;
+        lastPitch = Float.MAX_VALUE;
+        lastYaw = Float.MAX_VALUE;
+
+        PlayerConnection.LOGGER.debug("{} resetLastPositionRotation!", this.player.getName());
+    }
+
     public void e() {
         // Dionysus start - login async
         Runnable playerJoinReady = this.playerJoinReady;
